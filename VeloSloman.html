<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фиксация поломок велосипедов</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root {
            --primary-bg: #000;
            --primary-text: #fff;
            --border-color: #fff;
            --border-radius: 12px;
            --border-radius-small: 8px;
            --border-width: 1px;
            --transition: all 0.3s ease;
        }

        @font-face {
            font-family: 'Moscow Sans';
            src: url('fonts/MOSCOWSANSREGULAR.woff2') format('woff2'),
                url('fonts/MOSCOWSANSREGULAR.TTF') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Moscow Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary-text);
            min-height: 100vh;
            padding: 20px 12px 80px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .page-description {
            font-size: 16px;
            color: #ccc;
            line-height: 1.4;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-label {
            display: block;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: stretch;
            flex-wrap: nowrap;
        }

        .bike-input {
            flex: 1;
            min-width: 0;
            height: 50px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            padding: 0 15px;
            font-size: 16px;
            transition: var(--transition);
            box-sizing: border-box;
            }

        .bike-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .validate-btn {
            height: 50px;
            padding: 0 20px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .validate-btn:active {
            transform: scale(0.98);
        }

        .bike-section {
            margin-bottom: 30px;
            position: relative;
        }
        
        .bike-container {
            width: 100%;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            background: #3A3A3A;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
            box-sizing: border-box;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-height: 300px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .bike-svg {
            width: auto;
            height: 300px;
            min-width: 500px;
            display: block;
            margin: 0 auto;
            opacity: 1;
            transform: scale(0.95);
            transition: transform 0.5s ease;
        }

        .bike-svg.centered {
            transform: scale(1);
        }

        .bike-svg.loaded {
            opacity: 1;
            transform: scale(1);
        }

        .bike-container::-webkit-scrollbar {
            height: 8px;
        }

        .bike-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .bike-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .bike-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .bike-part {
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .bike-part:focus {
            outline: none;
        }

        @media (max-width: 768px) {
            .bike-svg {
                max-width: 450px;
            }
        }

        @media (max-width: 480px) {
            .bike-container {
                min-height: 250px;
                padding: 10px;
            }
            
            .bike-svg {
                max-width: 400px;
            }
        }

        @media (max-width: 400px) {
            .bike-svg {
                max-width: 350px;
            }
        }

        @media (max-width: 360px) {
            .bike-container {
                min-height: 220px;
            }
            
            .bike-svg {
                max-width: 320px;
            }
        }

        @media (max-width: 320px) {
            .bike-svg {
                max-width: 280px;
            }
        }

        .bike-part.active {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
            animation: pulse-glow 0.3s ease-out;
        }

        @keyframes pulse-glow {
            0% {
                filter: drop-shadow(0 0 0px rgba(255, 255, 255, 0));
            }
            50% {
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 1));
            }
            100% {
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
            }
        }

        .damage-dropdown {
            position: fixed;
            background: #1a1a1a;
            border: 2px solid #fff;
            border-radius: 12px;
            padding: 8px 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.2s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .dropdown-header {
            padding: 12px 16px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .damage-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .damage-option:last-child {
            border-bottom: none;
        }

        .damage-option:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .damage-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .damage-option.disabled:hover {
            background: transparent;
        }

        .damage-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .damage-dropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .damage-dropdown::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selected-damages {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .damages-list {
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 100px;
            padding: 15px;
        }

        .damage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.3s ease;
        }

        .damage-item:last-child {
            border-bottom: none;
        }

        .damage-info {
            flex: 1;
        }

        .damage-part {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 3px;
        }

        .damage-description {
            font-size: 14px;
            font-weight: bold;
        }

        .remove-damage {
            background: none;
            border: none;
            color: #ff4444;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .remove-damage:active {
            background: rgba(255, 68, 68, 0.2);
        }

        .empty-damages {
            text-align: center;
            color: #ccc;
            font-size: 14px;
            padding: 30px 0;
        }

        .photo-section {
            margin-bottom: 30px;
        }

        .photo-container {
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius-small);
            margin: 0 auto 15px auto;
            display: none;
        }

        .photo-preview.show {
            display: block;
        }

        .photo-buttons {
            display: flex;
            gap: 10px;
            align-items: stretch;
            width: 100%;
        }

        .take-photo-btn {
            flex: 1;
            height: 50px;
            padding: 0 20px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .take-photo-btn:active {
            transform: scale(0.98);
        }

        .icon-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .icon-btn:active {
            transform: scale(0.98);
        }

        .photo-btn {
            padding: 10px 20px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-btn:active {
            transform: scale(0.98);
        }

        .photo-btn.primary {
            background: var(--primary-text);
            color: var(--primary-bg);
        }

        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-container.active {
            display: flex;
        }

        .camera-video {
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
        }

        .camera-btn {
            padding: 12px 24px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .camera-btn.primary {
            background: var(--primary-text);
            color: var(--primary-bg);
        }

        .camera-btn:active {
            transform: scale(0.98);
        }

        .submit-section {
            text-align: center;
        }

        .submit-btn {
            height: 50px;
            padding: 0 40px;
            background: var(--primary-text);
            color: var(--primary-bg);
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        .modal-content {
            background: var(--primary-bg);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            max-width: 400px;
            width: 90%;
            position: relative;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .modal-text {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .modal-btn {
            display: block;
            font-weight: bold;
            width: 100%;
            height: 40px;
            background: var(--primary-text);
            color: var(--primary-bg);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            transition: all 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
            font-size: 14px;
            font-weight: bold;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .location-info {
            font-size: 14px;
            color: #ccc;
            margin-top: 10px;
            text-align: center;
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .qr-btn {
            width: 50px;
            height: 50px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .qr-btn:active {
            transform: scale(0.98);
        }

        .qr-btn svg {
            width: 20px;
            height: 20px;
        }

        #qr-scanner-container {
            display: none;
        }

        #qr-scanner-container.active {
            display: flex;
        }

        /* Стили для окна с днюхой */
        .birthday-modal .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            text-align: center;
        }

        .birthday-text {
            font-size: 18px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .birthday-content {
            text-align: center;
        }

        .birthday-emoji {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: block;
        }

        .telegram-link {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--primary-bg);
            border-top: var(--border-width) solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 3px 8px;
            border-radius: var(--border-radius);
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .nav-label {
            font-size: 12px;
        }

        .under-construction {
            text-align: center;
            padding: 60px 20px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            margin: 30px 0;
        }

        .under-construction h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .under-construction p {
            font-size: 16px;
            color: #ccc;
            line-height: 1.5;
        }

        .app-container {
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            padding-bottom: 60px; /* Для нижней навигации */
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        /* Стили для TimeStamp Camera */
        .timestamp-preview {
            width: 100%;
            height: 70vh;
            max-height: 600px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 9/16;
        }

        .timestamp-preview video,
        .timestamp-preview canvas,
        .timestamp-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .timestamp-loading {
            color: #ccc;
            font-size: 16px;
            text-align: center;
        }

        .timestamp-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            margin-top: auto;
            padding-bottom: 20px;
        }
 
        .timestamp-section {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
        }

        .timestamp-btn {
            padding: 12px 24px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            height: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timestamp-btn.primary {
            background: var(--primary-text);
            color: var(--primary-bg);
        }

        .timestamp-btn:active {
            transform: scale(0.98);
        }

        .timestamp-icon-btn {
            width: 50px;
            height: 50px;
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--primary-text);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timestamp-icon-btn.primary {
            background: var(--primary-text);
            color: var(--primary-bg);
        }

        .timestamp-icon-btn:active {
            transform: scale(0.98);
        }

        .timestamp-result {
            display: none;
            text-align: center;
        }

        .timestamp-result.active {
            display: block;
        }

        .timestamp-result-controls {
            display: none;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }

        .processed-photo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
        }

        .controls-transition {
            transition: all 0.3s ease;
        }

        @keyframes buttonTransform {
            0% { transform: scale(1); opacity: 1; }
            50% { opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        .button-transform {
            animation: buttonTransform 0.3s ease;
        }
    </style>
</head>
<body>
    <section id="main" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">Главная</h1>
                <p class="page-description">Тут у нас будет главная страница.</p>
            </div>
            <div class="under-construction">
                <h2>Раздел в разработке</h2>
                <p>Обновление этого раздела планируется 31.10.2025</p>
            </div>
        </div>
    </section>

    <section id="damage" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">Фиксация поломок</h1>
                <p class="page-description">Введи номер велосипеда и выбери его поврежденные детали</p>
            </div>

            <div class="input-section">
                <label class="input-label">Номер велосипеда</label>
                <div class="input-wrapper">
                    <input type="text" class="bike-input" id="bike-number" placeholder="20000-29030" maxlength="5" inputmode="numeric" pattern="[0-9]*">
                    <button class="qr-btn" id="scan-qr-btn" title="Сканировать QR-код">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <path d="M10 3v4a1 1 0 0 1-1 1H3"/>
                            <path d="M14 21v-4a1 1 0 0 1 1-1h6"/>
                            <path d="M21 14h-4a1 1 0 0 1-1-1V3"/>
                            <path d="M3 10h4a1 1 0 0 1 1 1v10"/>
                        </svg>
                    </button>
                </div>
                <div class="error-message" id="number-error">Номер должен быть от 20000 до 29030</div>
            </div>

            <div class="bike-section">
                <div class="bike-container">
                    <!-- SVG велосипеда будет вставлено здесь -->
                    <div id="bike-svg-container"></div>
                </div>
                <div class="damage-dropdown" id="damage-dropdown"></div>
            </div>

            <div class="selected-damages">
                <h2 class="section-title">Выбранные поломки</h2>
                <div class="damages-list" id="damages-list">
                    <div class="empty-damages">Поломки не выбраны</div>
                </div>
            </div>

            <div class="photo-section">
                <h2 class="section-title">Фотография поломки</h2>
                <div class="photo-container">
                    <img id="photo-preview" class="photo-preview" src="" alt="Предпросмотр фото">
                    <div class="photo-buttons">
                        <button class="take-photo-btn" id="take-photo-btn">Сделать фото</button>
                        <div class="icon-buttons">
                            <button class="icon-btn" id="upload-photo-btn" title="Загрузить из галереи">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </button>
                            <button class="icon-btn primary" id="remove-photo-btn" style="display:none;" title="Удалить фото">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="location-info" id="location-info">Координаты будут получены при отправке заявки</div>
                </div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" id="submit-btn" disabled>Отправить заявку</button>
            </div>
        </div>

        <!-- Камера -->
        <div class="camera-container" id="camera-container">
            <video id="camera-video" class="camera-video" autoplay playsinline></video>
            <div class="camera-controls">
                <button class="camera-btn" id="cancel-camera-btn">Отмена</button>
                <button class="camera-btn primary" id="capture-btn">Сделать снимок</button>
            </div>
        </div>

        <div class="camera-container" id="qr-scanner-container">
            <video id="qr-scanner-video" class="camera-video" autoplay playsinline></video>
                <div class="scanner-overlay">
                    <div class="scanner-frame"></div>
                </div>
                <div class="camera-controls">
                    <button class="camera-btn" id="cancel-qr-scan-btn">Отмена</button>
                </div>
        </div>


        <!-- Модальное окно подтверждения -->
        <div class="modal" id="confirmation-modal">
            <div class="modal-content">
                <span class="modal-close" id="modal-close">&times;</span>
                <h2 class="modal-title">Заявка отправлена</h2>
                <p class="modal-text">Заявка на велосипед №<span id="bike-number-confirm"></span> успешно отправлена Лёхе.</p>
                <button class="modal-btn" id="modal-ok-btn">Хорошо</button>
            </div>
        </div>
    </section>
    
    <section id="timestamp" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">TimeStamp</h1>
                <p class="page-description">Мгновенная фиксация местоположения и времени</p>
            </div>

            <div class="timestamp-section">
                <div class="timestamp-preview" id="timestamp-preview">
                    <div class="timestamp-loading" id="timestamp-loading">
                        Получение геопозиции...
                    </div>
                    <video id="timestamp-video" style="display: none;" autoplay playsinline></video>
                    <canvas id="timestamp-canvas" style="display: none;"></canvas>
                    <img id="processed-photo-preview" class="processed-photo" style="display: none;" src="" alt="Обработанное фото">
                </div>

                <div class="timestamp-controls" id="timestamp-controls">
                    <button class="timestamp-btn" id="timestamp-capture-btn" style="display: none;">Сфотографировать</button>
                    
                    <div class="timestamp-result-controls" id="timestamp-result-controls" style="display: none;">
                        <button class="timestamp-btn" id="retake-btn">Переснять</button>
                        <button class="timestamp-icon-btn primary" id="send-telegram-btn" title="Отправить в Telegram">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" d="M24 12C24 18.6274 18.6274 24 12 24C5.37258 24 0 18.6274 0 12C0 5.37258 5.37258 0 12 0C18.6274 0 24 5.37258 24 12ZM12.43 8.85893C11.2629 9.3444 8.93015 10.3492 5.43191 11.8733C4.86385 12.0992 4.56628 12.3202 4.53919 12.5363C4.4934 12.9015 4.95073 13.0453 5.57349 13.2411C5.6582 13.2678 5.74598 13.2954 5.83596 13.3246C6.44866 13.5238 7.27284 13.7568 7.70131 13.766C8.08996 13.7744 8.52375 13.6142 9.00266 13.2853C12.2712 11.079 13.9584 9.96381 14.0643 9.93977C14.1391 9.92281 14.2426 9.90148 14.3128 9.96385C14.3829 10.0262 14.3761 10.1443 14.3686 10.176C14.3233 10.3691 12.5281 12.0381 11.5991 12.9018C11.3095 13.171 11.1041 13.362 11.0621 13.4056C10.968 13.5034 10.8721 13.5958 10.78 13.6846C10.2108 14.2333 9.78393 14.6448 10.8036 15.3168C11.2937 15.6397 11.6858 15.9067 12.077 16.1731C12.5042 16.4641 12.9303 16.7543 13.4816 17.1157C13.6221 17.2078 13.7562 17.3034 13.8869 17.3965C14.3841 17.751 14.8308 18.0694 15.3826 18.0186C15.7033 17.9891 16.0345 17.6876 16.2027 16.7884C16.6002 14.6632 17.3816 10.0585 17.5622 8.16098C17.5781 7.99473 17.5582 7.78197 17.5422 7.68858C17.5262 7.59518 17.4928 7.46211 17.3714 7.3636C17.2276 7.24694 17.0057 7.22234 16.9064 7.22408C16.455 7.23204 15.7626 7.47282 12.43 8.85893Z" fill="#000000"/>
                            </svg>
                        </button>
                        <button class="timestamp-icon-btn primary" id="download-btn" title="Скачать">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="location-info" id="timestamp-location-info">
                    Ожидание геопозиции...
                </div>
            </div>
        </div>
    </section>

    <section id="profile" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">Профиль</h1>
                <p class="page-description">Профиль. Информация о тебе, как о пользователе.</p>
            </div>
            <div class="under-construction">
                <h2>Раздел в разработке</h2>
                <p>Обновление этого раздела планируется 28.10.2025</p>
            </div>
        </div>
    </section>

    <!-- Уведомление -->
    <div class="notification" id="notification"></div>

    <!-- Нижнее меню -->
    <nav class="bottom-nav">
        <div class="nav-item" data-page="main">
            <div class="nav-icon">
                <img src="media/icons/main.png" alt="Главная">
            </div>
            <span class="nav-label">Главная</span>
        </div>
        <div class="nav-item" data-page="damage">
            <div class="nav-icon">
                <img src="media/icons/damage.png" alt="Поломки">
            </div>
            <span class="nav-label">Поломки</span>
        </div>
        <div class="nav-item" data-page="timestamp">
            <div class="nav-icon">
                <img src="media/icons/timestamp.png" alt="TimeStamp">
            </div>
            <span class="nav-label">TimeStamp</span>
        </div>
        <div class="nav-item" data-page="profile">
            <div class="nav-icon">
                <img src="media/icons/profile.png" alt="Профиль">
            </div>
            <span class="nav-label">Профиль</span>
        </div>
    </nav>

    <script>
    let currentBikeNumber = '';
    let selectedDamages = [];
    let currentPart = null;
    let telegramWebApp = null;
    let damageData = {};
    let currentPhoto = null;
    let userLocation = null;
    let userData = null;
    let qrScannerStream = null;
    let qrScanInterval = null;

    // TimeStamp переменные
    let timestampStream = null;
    let timestampCanvas = null;
    let timestampContext = null;
    let currentProcessedPhoto = null;
    let userCoords = null;
    let userAddress = null;

    let securityLogs = [];
    let requestLimits = new Map();
    const _a1 = [1618025244, 6310949297];

    // Константы для TimeStamp
    const BOT_TOKEN = '8201906085:AAGHwKDDvx_X4oixEU0tov8TBfBompX_ZO4';
    const ADMIN_CHAT_ID = '-1002981629310';
    const TIMESTAMP_TOPIC_ID = 22;

    function initSecurity() {
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                (e.ctrlKey && e.shiftKey && e.key === 'C') || 
                (e.ctrlKey && e.shiftKey && e.key === 'P') || 
                (e.ctrlKey && e.key === 'u') ||
                (e.ctrlKey && e.key === 's') ||
                (e.ctrlKey && e.key === 'p') ||
                (e.ctrlKey && e.key === 'a') ||
                (e.metaKey && e.key === 's')) {
                e.preventDefault();
                return false;
            }
        });
        
        const userData = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const isAuthorized = userData && _a1.includes(userData.id);
        
        console.log('🔐 Security check:', { 
            hasUserData: !!userData, 
            userId: userData?.id,
            isAuthorized 
        });
        
        if (!isAuthorized) {
            console.log('🚫 Unauthorized access - enabling hard security');
            
            let devToolsOpen = false;
            let reloadCount = 0;
            const maxReloads = 10;
            
            setInterval(function() {
                const widthThreshold = window.outerWidth - window.innerWidth > 160;
                const heightThreshold = window.outerHeight - window.innerHeight > 160;
                
                if ((widthThreshold || heightThreshold) && !devToolsOpen && reloadCount < maxReloads) {
                    devToolsOpen = true;
                    reloadCount++;
                    
                    logSecurityEvent('UNAUTHORIZED_DEVTOOLS_DETECTED', { 
                        userId: userData?.id || 'unknown',
                        reloadCount,
                        maxReloads
                    });
                    
                    console.log(`🚫 Unauthorized DevTools - reloading (${reloadCount}/${maxReloads})`);
                    window.location.reload();
                }
            }, 1000);
            
            const element = new Image();
            Object.defineProperty(element, 'id', {
                get: function() {
                    console.log('🚫 Unauthorized console access detected');
                    window.location.reload();
                }
            });
            console.log('%c', element);
            
        } else {
            console.log('✅ Authorized user - relaxed security mode');
        }
    }

    console.log = function() {};
    console.error = function() {};
    console.warn = function() {};
    console.info = function() {};

    function isLegitimateTelegramWebApp() {
        const webApp = window.Telegram?.WebApp;
        if (!webApp) {
            logSecurityEvent('NO_TELEGRAM_WEBAPP', { reason: 'Telegram object not found' });
            return false;
        }
        
        if (!webApp.initData) {
            logSecurityEvent('NO_INIT_DATA', { reason: 'Missing initData' });
            return false;
        }
        
        if (!webApp.initDataUnsafe?.user?.id) {
            logSecurityEvent('NO_USER_DATA', { reason: 'Missing user data' });
            return false;
        }
        
        return true;
    }

    function isUserAuthorized(userData) {
        if (!userData || !userData.id) {
            logSecurityEvent('UNAUTHORIZED_NO_ID', { userData });
            return false;
        }
        
        const isAllowed = _a1.includes(userData.id);
        
        if (!isAllowed) {
            logSecurityEvent('UNAUTHORIZED_USER', { 
                userId: userData.id, 
                username: userData.username,
                allowedUsers: _a1 
            });
        }
        
        return isAllowed;
    }

    function checkAndUpdateRateLimit(userId) {
        const now = Date.now();
        const WINDOW_MS = 3600000;
        const MAX_REQUESTS = 20;
        
        let userRequests = requestLimits.get(userId) || [];
        
        userRequests = userRequests.filter(time => now - time < WINDOW_MS);
        
        if (userRequests.length >= MAX_REQUESTS) {
            logSecurityEvent('RATE_LIMIT_EXCEEDED', { 
                userId, 
                requestsCount: userRequests.length,
                timeWindow: '1 hour'
            });
            return false;
        }
        
        userRequests.push(now);
        requestLimits.set(userId, userRequests);
        
        logSecurityEvent('RATE_LIMIT_UPDATE', { 
            userId, 
            currentRequests: userRequests.length 
        });
        
        return true;
    }

    function logSecurityEvent(eventType, details) {
        const logEntry = {
            timestamp: new Date().toISOString(),
            eventType: eventType,
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            url: window.location.href,
            hash: window.location.hash,
            userData: window.Telegram?.WebApp?.initDataUnsafe?.user || null,
            details: details
        };
        
        securityLogs.push(logEntry);
        console.log('🔐 SECURITY:', logEntry);
        
        if (eventType.includes('UNAUTHORIZED') || eventType.includes('LIMIT_EXCEEDED')) {
            sendSecurityAlertToTelegram(logEntry);
        }
    }

    async function sendSecurityAlertToTelegram(alertData) {
        const _b2 = '8201906085:AAGHwKDDvx_X4oixEU0tov8TBfBompX_ZO4';
        const _c3 = '1618025244';
        
        const alertMessage = `🚨 SECURITY ALERT
                            Событие: ${alertData.eventType}
                            Время: ${new Date().toLocaleString()}
                            Пользователь: ${alertData.userData?.id || 'Неизвестен'}
                            User-Agent: ${alertData.userAgent}

                            Детали: ${JSON.stringify(alertData.details, null, 2)}`;
        
        try {
            await fetch(`https://api.telegram.org/bot${_b2}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: _c3,
                    text: alertMessage
                })
            });
        } catch (error) {
            console.error('Ошибка отправки алерта:', error);
        }
    }

    function performSecurityChecks() {
        if (!isLegitimateTelegramWebApp()) {
            showNotification('Доступ только через мини-апп в телеге');
            return false;
        }
        
        const userData = window.Telegram.WebApp.initDataUnsafe.user;
        
        if (!isUserAuthorized(userData)) {
            showNotification('Доступ ограничен. Обратись к администратору.');
            return false;
        }
        
        if (!checkAndUpdateRateLimit(userData.id)) {
            showNotification('Превышен лимит заявок. Попробу позже.');
            return false;
        }
        
        logSecurityEvent('SECURITY_CHECKS_PASSED', { userId: userData.id });
        return true;
    }

    function showSecurityDashboard() {
        console.log('=== VELOSLOMAN SECURITY DASHBOARD ===');
        console.log('Всего событий:', securityLogs.length);
        console.log('Лимиты пользователей:', Array.from(requestLimits.entries()));
        console.table(securityLogs.slice(-10));
        return securityLogs;
    }

    function clearSecurityData() {
        securityLogs = [];
        requestLimits.clear();
        console.log('🔓 Данные безопасности очищены');
    }

    function initTelegramWebApp() {
        if (window.Telegram && window.Telegram.WebApp) {
            telegramWebApp = window.Telegram.WebApp;
            telegramWebApp.ready();
            telegramWebApp.expand();
            
            if (telegramWebApp.initDataUnsafe.user) {
                userData = telegramWebApp.initDataUnsafe.user;
                console.log('Данные пользователя:', userData);
            }
        }
    }

    // TimeStamp функции
    async function initTimestampCamera() {
        if (timestampStream) {
            timestampStream.getTracks().forEach(track => track.stop());
            timestampStream = null;
        }

        document.getElementById('timestamp-loading').style.display = 'block';
        document.getElementById('timestamp-capture-btn').style.display = 'none';
        document.getElementById('timestamp-result-controls').style.display = 'none';
        document.getElementById('processed-photo-preview').style.display = 'none';
        document.getElementById('timestamp-video').style.display = 'block';

        timestampCanvas = document.getElementById('timestamp-canvas');
        timestampContext = timestampCanvas.getContext('2d', { willReadFrequently: true });
        
        // Получаем геопозицию при загрузке раздела
        await getTimestampLocation();
        
        // Инициализируем камеру
        try {
            timestampStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false
            });
            
            const video = document.getElementById('timestamp-video');
            video.srcObject = timestampStream;
            video.style.display = 'block';
            
            video.onloadedmetadata = () => {
                video.play();
                document.getElementById('timestamp-loading').style.display = 'none';
                document.getElementById('timestamp-capture-btn').style.display = 'block';
            };
            
        } catch (error) {
            console.error('Ошибка доступа к камере:', error);
            showNotification('Не удалось получить доступ к камере');
            document.getElementById('timestamp-loading').textContent = 'Ошибка доступа к камере';
        }
    }

    async function getTimestampLocation() {
        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
            
            userCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };
            
            // Получаем адрес
            userAddress = await getAddressFromCoords(userCoords.latitude, userCoords.longitude);
            
            document.getElementById('timestamp-location-info').textContent = 
                `Координаты: ${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}`;
                
            document.getElementById('timestamp-loading').textContent = 'Камера готова';
            
        } catch (error) {
            console.error('Ошибка получения геолокации:', error);
            document.getElementById('timestamp-location-info').textContent = 
                'Не удалось получить геопозицию';
            document.getElementById('timestamp-loading').textContent = 'Ошибка геопозиции';
        }
    }

    async function getAddressFromCoords(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.address) {
                const addr = data.address;
                const components = [];

                if (addr.town) components.push(addr.town);
                if (addr.suburb) components.push(addr.suburb);
                if (addr.road) components.push(addr.road);
                if (addr.house_number) components.push(addr.house_number);
                
                // if (addr.city) components.push(addr.city);
                // if (addr.village) components.push(addr.village);
                // if (addr.state) components.push(addr.state);
                if (addr.postcode) components.push(addr.postcode);
                
                return components.join(', ');
            }
        } catch (error) {
            console.error('Ошибка геокодирования:', error);
        }
        
        return 'Адрес не определен';
    }

    function captureTimestampPhoto() {
        const video = document.getElementById('timestamp-video');
        const canvas = document.getElementById('timestamp-canvas');
        
        // Увеличиваем качество фото
        canvas.width = video.videoWidth * 2;
        canvas.height = video.videoHeight * 2;
        
        // Рисуем с высоким качеством
        timestampContext.imageSmoothingEnabled = true;
        timestampContext.imageSmoothingQuality = 'high';
        timestampContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Останавливаем камеру
        if (timestampStream) {
            timestampStream.getTracks().forEach(track => track.stop());
        }

        // Анимация перехода кнопок
        animateButtonTransition();

        // Обрабатываем фото с обработкой ошибок
        try {
            processTimestampPhoto();
        } catch (error) {
            console.error('Ошибка обработки фото:', error);
            showNotification('Ошибка обработки фото');
            // В случае ошибки возвращаем кнопку "Сфотографировать"
            retakeTimestampPhoto();
        }
    }

    function animateButtonTransition() {
        const captureBtn = document.getElementById('timestamp-capture-btn');
        const resultControls = document.getElementById('timestamp-result-controls');
        
        // Анимация исчезновения кнопки "Сфотографировать"
        captureBtn.style.animation = 'buttonTransform 0.3s ease';
        setTimeout(() => {
            captureBtn.style.display = 'none';
            // Показываем кнопки управления
            resultControls.style.display = 'flex';
            resultControls.style.animation = 'buttonTransform 0.3s ease';
        }, 150);
    }

    async function processTimestampPhoto() {
        const originalCanvas = document.getElementById('timestamp-canvas');
        
        if (!originalCanvas || originalCanvas.width === 0) {
            throw new Error('Нет данных для обработки');
        }

        const processedCanvas = document.createElement('canvas');
        const ctx = processedCanvas.getContext('2d', { willReadFrequently: true });
        
        // Сохраняем высокое качество
        processedCanvas.width = originalCanvas.width;
        processedCanvas.height = originalCanvas.height;
        
        // Настройки качества
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.textRendering = 'optimizeLegibility';
        
        // Рисуем оригинальное фото
        const scale = Math.max(processedCanvas.width / originalCanvas.width, processedCanvas.height / originalCanvas.height);
        const x = (processedCanvas.width - originalCanvas.width * scale) / 2;
        const y = (processedCanvas.height - originalCanvas.height * scale) / 2;

        ctx.drawImage(originalCanvas, x, y, originalCanvas.width * scale, originalCanvas.height * scale);

        // Добавляем карту (левый верхний угол)
        await addMapToPhoto(ctx, processedCanvas.width, processedCanvas.height);
        
        // Добавляем логотип (правый верхний угол)
        await addLogoToPhoto(ctx, processedCanvas.width, processedCanvas.height);
        
        // Добавляем текст (внизу)
        addTextToPhoto(ctx, processedCanvas.width, processedCanvas.height);
        
        // Сохраняем обработанное фото с высоким качеством
        currentProcessedPhoto = processedCanvas.toDataURL('image/jpeg', 0.95);
        
        // Показываем обработанное фото в превью
        const previewImg = document.getElementById('processed-photo-preview');
        previewImg.src = currentProcessedPhoto;
        previewImg.style.display = 'block';
        
        // Скрываем видео и канвас
        document.getElementById('timestamp-video').style.display = 'none';
        document.getElementById('timestamp-canvas').style.display = 'none';
        
        showNotification('Фото обработано!');
    }

    async function addMapToPhoto(ctx, width, height) {
        if (!userCoords) return;
        
        try {
            // Создаем карту с Яндекс.Карт
            const mapSize = Math.min(width * 0.8, height * 0.25);
            const mapX = 50;
            const mapY = 50;
            
            const mapUrl = `https://static-maps.yandex.ru/1.x/?ll=${userCoords.longitude},${userCoords.latitude}&z=16&size=${Math.round(mapSize)},${Math.round(mapSize)}&l=map`;
            
            const mapResponse = await fetch(mapUrl);
            if (!mapResponse.ok) throw new Error(`HTTP error! status: ${mapResponse.status}`);
            const mapBlob = await mapResponse.blob();
            const mapImg = await createImageBitmap(mapBlob);
            
            // Рисуем карту с закругленными углами
            const cornerRadius = 15;
            ctx.save();
            ctx.beginPath();
            ctx.roundRect(mapX, mapY, mapSize, mapSize, cornerRadius);
            ctx.clip();
            ctx.drawImage(mapImg, mapX, mapY, mapSize, mapSize);
            ctx.restore();
            
            // Добавляем метку поверх карты
            const markerImg = new Image();
            markerImg.src = 'media/metka.png';
            await new Promise(resolve => {
                markerImg.onload = resolve;
            });
            
            const markerSize = mapSize * 0.25;
            const markerX = mapX + (mapSize - markerSize) / 2;
            const markerY = mapY + (mapSize - markerSize) / 2 - markerSize * 0.15;
            
            ctx.drawImage(markerImg, markerX, markerY, markerSize, markerSize);
            
            // Добавляем подпись под картой
            ctx.fillStyle = '#E76623';
            ctx.font = 'bold 36px "Moscow Sans"';
            ctx.textAlign = 'left';
            ctx.fillText('Кто я?', mapX, mapY + mapSize + 50);
            
        } catch (error) {
            console.error('Ошибка добавления карты:', error);
            // Резервный вариант - рисуем простую карту
            showNotification(error)
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(mapX, mapY, mapSize, mapSize);
            ctx.strokeStyle = '#E76623';
            ctx.lineWidth = 3;
            ctx.strokeRect(mapX, mapY, mapSize, mapSize);
            ctx.fillStyle = '#E76623';
            ctx.font = 'bold 24px "Moscow Sans"';
            ctx.textAlign = 'center';
            ctx.fillText('Карта', mapX + mapSize/2, mapY + mapSize/2);
            return; 
        }
    }

    async function addLogoToPhoto(ctx, width, height) {
        try {
            const logoImg = new Image();
            logoImg.src = 'media/vblogo.png';
            await new Promise(resolve => {
                logoImg.onload = resolve;
            });
            
            // Учитываем пропорции логотипа 807x313
            const logoAspectRatio = 807 / 313;
            const logoHeight = Math.min(height * 0.15, 150);
            const logoWidth = logoHeight * logoAspectRatio;
            
            const logoX = width - logoWidth - 30;
            const logoY = 30;
            
            // Рисуем логотип с закругленными углами
            ctx.save();
            ctx.beginPath();
            ctx.roundRect(logoX, logoY, logoWidth, logoHeight, cornerRadius);
            ctx.clip();
            ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
            ctx.restore();
            
        } catch (error) {
            console.error('Ошибка добавления логотипа:', error);
        }
    }

    function addTextToPhoto(ctx, width, height) {
        if (!userCoords || !userAddress) return;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU');
        const dateString = now.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        const coordString = `${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}`;
        
        // Настройки текста - увеличенные размеры для лучшего качества
        ctx.fillStyle = '#00ff00'; // Ярко-зеленый
        ctx.strokeStyle = '#000000'; // Черная обводка
        ctx.lineWidth = 4;
        ctx.textAlign = 'center';
        ctx.font = 'bold 38px "Moscow Sans"';
        ctx.textRendering = 'optimizeLegibility';
        
        const textX = width / 2;
        const textY = height - 150;
        
        const lines = [
            `${timeString} — ${dateString}`,
            coordString,
            userAddress.substring(0, 40) + (userAddress.length > 40 ? '...' : '')
        ];
        
        // Рисуем текст с обводкой
        lines.forEach((line, index) => {
            const y = textY + (index * 45);
            
            // Обводка
            ctx.strokeText(line, textX, y);
            // Заливка
            ctx.fillText(line, textX, y);
        });
    }

    async function sendTimestampToTelegram() {
        if (!currentProcessedPhoto || !userCoords) {
            showNotification('Ошибка: нет фото или геопозиции');
            return;
        }
        
        try {
            // Конвертируем dataURL в blob
            const response = await fetch(currentProcessedPhoto);
            const blob = await response.blob();
            
            // Формируем подпись
            const username = userData?.username || 'Неизвестен';
            const caption = `TimeStamp фоточка от @${username}\n\nПолучены координаты: ${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}\nВыдан адрес: ${userAddress}\n\n#timestamp`;
            
            // Отправляем в группу (топик 22)
            const formData = new FormData();
            formData.append('chat_id', ADMIN_CHAT_ID);
            formData.append('message_thread_id', TIMESTAMP_TOPIC_ID);
            formData.append('photo', blob, 'timestamp.jpg');
            formData.append('caption', caption);
            
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                method: 'POST',
                body: formData
            });
            
            // Отправляем пользователю
            const userFormData = new FormData();
            userFormData.append('chat_id', userData.id);
            userFormData.append('photo', blob, 'timestamp.jpg');
            userFormData.append('caption', 'Ваше TimeStamp фото');
            
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                method: 'POST',
                body: userFormData
            });
            
            showNotification('Фото отправлено в Telegram');
            
        } catch (error) {
            console.error('Ошибка отправки в Telegram:', error);
            showNotification('Ошибка отправки фото');
        }
    }

    function downloadTimestampPhoto() {
        if (!currentProcessedPhoto) {
            showNotification('Ошибка: нет фото для скачивания');
            return;
        }
        
        const link = document.createElement('a');
        link.download = `timestamp_${Date.now()}.jpg`;
        link.href = currentProcessedPhoto;
        link.click();
        
        showNotification('Фото скачано');
    }

    function retakeTimestampPhoto() {
        // Сбрасываем состояние
        const previewImg = document.getElementById('processed-photo-preview');
        const video = document.getElementById('timestamp-video');
        const canvas = document.getElementById('timestamp-canvas');
        const captureBtn = document.getElementById('timestamp-capture-btn');
        const resultControls = document.getElementById('timestamp-result-controls');
        
        previewImg.style.display = 'none';
        previewImg.src = '';
        canvas.style.display = 'none';
        
        // Анимация перехода обратно
        resultControls.style.animation = 'buttonTransform 0.3s ease';
        setTimeout(() => {
            resultControls.style.display = 'none';
            captureBtn.style.display = 'block';
            captureBtn.style.animation = 'buttonTransform 0.3s ease';
        }, 150);
        
        // Перезапускаем камеру
        initTimestampCamera();
    }

    function initQRScanner() {
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        const qrScannerVideo = document.getElementById('qr-scanner-video');
        const cancelQrScanBtn = document.getElementById('cancel-qr-scan-btn');
        
        scanQrBtn.addEventListener('click', startQRScan);
        cancelQrScanBtn.addEventListener('click', stopQRScan);
        
        async function startQRScan() {
            try {                
                qrScannerStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                qrScannerVideo.srcObject = qrScannerStream;
                qrScannerContainer.classList.add('active');
                
                qrScannerVideo.onloadedmetadata = () => {
                    qrScannerVideo.play();
                    startQRDetection();
                };
                
            } catch (error) {
                console.error('Ошибка доступа к камере:', error);
                showNotification('Не удалось получить доступ к камере');
            }
        }
        
        function stopQRScan() {
            if (qrScanInterval) {
                clearInterval(qrScanInterval);
                qrScanInterval = null;
            }
            
            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }
            
            qrScannerContainer.classList.remove('active');
        }
        
        function startQRDetection() {
            let scanAttempts = 0;
            
            qrScanInterval = setInterval(() => {
                if (qrScannerVideo.readyState === qrScannerVideo.HAVE_ENOUGH_DATA) {
                    scanAttempts++;
                    
                    try {
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        
                        canvas.width = qrScannerVideo.videoWidth;
                        canvas.height = qrScannerVideo.videoHeight;
                        
                        context.drawImage(qrScannerVideo, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        if (scanAttempts % 10 === 0) {
                            console.log(`QR сканирование: попытка ${scanAttempts}, видео: ${canvas.width}x${canvas.height}`);
                        }
                        
                        if (code) {
                            console.log('НАЙДЕН QR-КОД:', code.data);
                            console.log('Детали QR:', {
                                data: code.data,
                                version: code.version,
                                location: code.location
                            });
                            processQRCode(code.data);
                        }
                        
                    } catch (error) {
                        console.error('Ошибка анализа QR-кода:', error);
                    }
                }
            }, 300);
        }
        
        function processQRCode(qrData) {
            console.log('Обработка QR-кода:', qrData);
            
            const match = qrData.match(/https:\/\/velobike\.ru\/shorturl\/omni\/\{?(\d+)\}?/);
            
            if (match && match[1]) {
                const bikeNumber = match[1];
                console.log('Извлечен номер:', bikeNumber);
                
                if (validateBikeNumber(bikeNumber)) {
                    document.getElementById('bike-number').value = bikeNumber;
                    currentBikeNumber = bikeNumber;
                    
                    document.getElementById('number-error').style.display = 'none';
                    document.getElementById('bike-number').style.borderColor = '';
                    updateSubmitButton();
                    stopQRScan();
                } else {
                    console.log('Невалидный номер:', bikeNumber);
                    showNotification(`Номер ${bikeNumber} не в диапазоне 20000-29030`);
                }
            } else {
                console.log('Неверный формат QR-кода:', qrData);
            }
        }
    }

    async function loadDamageData() {
        try {
            const response = await fetch('db/damages.json');
            const data = await response.json();
            damageData = data.parts;
            console.log('Данные о поломках загружены');
        } catch (error) {
            console.error('Ошибка загрузки данных о поломках:', error);
            damageData = {};
        }
    }

    function centerBikeSVG() {
        const container = document.querySelector('.bike-container');
        const svg = document.querySelector('.bike-svg');
        
        if (container && svg) {
            svg.style.transform = 'scale(0.95)';
            
            requestAnimationFrame(() => {
                const containerWidth = container.clientWidth;
                const svgWidth = svg.scrollWidth;
                
                const scrollLeft = Math.max(0, (svgWidth - containerWidth) / 2);
                
                container.style.scrollBehavior = 'smooth';
                container.scrollLeft = scrollLeft;
            });
        }
    }

    async function loadBikeSVG() {
        try {
            const response = await fetch('vel.svg');
            const svgText = await response.text();
            const svgContainer = document.getElementById('bike-svg-container');
            svgContainer.innerHTML = svgText;
            
            const svg = svgContainer.querySelector('svg');
            if (svg) {
                svg.classList.add('bike-svg');
            }
            
            setTimeout(() => {
                setupBikePartsInteractivity();
            }, 100);
        } catch (error) {
            console.error('Ошибка загрузки SVG:', error);
            loadFallbackSVG();
        }
    }

    function loadFallbackSVG() {
        const svgContainer = document.getElementById('bike-svg-container');
        svgContainer.innerHTML = ``;
        
        setTimeout(() => {
            setupBikePartsInteractivity();
        }, 100);
    }

    function setupBikePartsInteractivity() {
        const parts = document.querySelectorAll('.bike-part');
        parts.forEach(part => {
            part.style.webkitTapHighlightColor = 'transparent';
            part.style.outline = 'none';
            
            part.addEventListener('click', handlePartClick);
            part.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handlePartClick(e);
            });
        });
    }

    function handlePartClick(event) {
        event.preventDefault();
        event.stopPropagation();

        const partId = event.currentTarget.id;
        currentPart = partId;
        
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        showDamageDropdown(partId, event.currentTarget);
    }

    function showDamageDropdown(partId, partElement) {
        const dropdown = document.getElementById('damage-dropdown');
        const rect = partElement.getBoundingClientRect();
        const viewport = {
            width: window.innerWidth,
            height: window.innerHeight
        };
        
        let left = rect.left;
        let top = rect.bottom + 5;
        
        const dropdownWidth = Math.min(280, viewport.width - 40);
        const dropdownMaxHeight = 200;
        
        if (left + dropdownWidth > viewport.width - 10) {
            left = viewport.width - dropdownWidth - 10;
        }
        
        if (left < 10) {
            left = 10;
        }
        
        const estimatedHeight = Math.min(dropdownMaxHeight, (damageData[partId]?.length || 0) * 40 + 60);
        if (top + estimatedHeight > viewport.height - 10) {
            top = rect.top - estimatedHeight - 5;
        }
        
        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';
        dropdown.style.width = dropdownWidth + 'px';
        dropdown.style.maxHeight = dropdownMaxHeight + 'px';
        dropdown.style.display = 'block';
        dropdown.style.zIndex = '1000';
        
        const damages = damageData[partId] || [];
        dropdown.innerHTML = '';
        
        const header = document.createElement('div');
        header.className = 'dropdown-header';
        header.textContent = getPartName(partId);
        dropdown.appendChild(header);
        
        if (damages.length === 0) {
            const option = document.createElement('div');
            option.className = 'damage-option';
            option.textContent = 'Нет данных о поломках';
            dropdown.appendChild(option);
            return;
        }
        
        const existingDamagesForPart = selectedDamages
            .filter(damage => damage.part === partId)
            .map(damage => damage.description);
        
        damages.forEach(damage => {
            const option = document.createElement('div');
            option.className = 'damage-option';
            option.textContent = damage;
            
            if (existingDamagesForPart.includes(damage)) {
                option.classList.add('disabled');
            } else {
                option.addEventListener('click', () => selectDamage(damage, partId));
            }
            
            dropdown.appendChild(option);
        });
        
        setTimeout(() => {
            document.addEventListener('click', closeDropdownOnClickOutside);
        }, 10);
    }

    function closeDropdownOnClickOutside(event) {
        const dropdown = document.getElementById('damage-dropdown');
        if (!dropdown.contains(event.target) && !event.target.closest('.bike-part')) {
            dropdown.style.display = 'none';
            document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
            document.removeEventListener('click', closeDropdownOnClickOutside);
        }
    }

    function selectDamage(damage, partId) {
        const isAlreadySelected = selectedDamages.some(
            d => d.part === partId && d.description === damage
        );
        
        if (isAlreadySelected) {
            showNotification('Эта поломка уже выбрана для этой детали');
            return;
        }
        
        const damageId = Date.now();
        
        selectedDamages.push({
            id: damageId,
            part: partId,
            description: damage
        });
        
        updateDamagesList();
        updateSubmitButton();
        
        document.getElementById('damage-dropdown').style.display = 'none';
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
        document.removeEventListener('click', closeDropdownOnClickOutside);
        
        showNotification('Поломка добавлена');
    }

    function updateDamagesList() {
        const list = document.getElementById('damages-list');
        
        if (selectedDamages.length === 0) {
            list.innerHTML = '<div class="empty-damages">Поломки не выбраны</div>';
            return;
        }
        
        list.innerHTML = '';
        selectedDamages.forEach(damage => {
            const item = document.createElement('div');
            item.className = 'damage-item';
            item.innerHTML = `
                <div class="damage-info">
                    <div class="damage-part">${getPartName(damage.part)}</div>
                    <div class="damage-description">${damage.description}</div>
                </div>
                <button class="remove-damage" data-id="${damage.id}">×</button>
            `;
            list.appendChild(item);
        });
        
        document.querySelectorAll('.remove-damage').forEach(btn => {
            btn.addEventListener('click', removeDamage);
        });
    }

    function removeDamage(event) {
        const damageId = parseInt(event.target.getAttribute('data-id'));
        selectedDamages = selectedDamages.filter(damage => damage.id !== damageId);
        updateDamagesList();
        updateSubmitButton();
        showNotification('Поломка удалена');
    }

    function getPartName(partId) {
        const partNames = {
            'rear-wheel': 'Заднее колесо',
            'front-wheel': 'Переднее колесо',
            'motor': 'Мотор',
            'rear-ad-sign': 'Задний рекламный щит',
            'front-ad-sign': 'Передний рекламный щит',
            'lock': 'Замок',
            'frame': 'Рама и остальное',
            'chain': 'Цепь',
            'battery': 'АКБ',
            'footboard': 'Подножка',
            'saddle': 'Сиденье',
            'handlebars': 'Руль',
            'pedals': 'Педали',
            'chain-guard': 'Защита цепи',
            'light-marker': 'Световой маркер',
            'retroreflector': 'Светоотражатель',
            'gearshift': 'Переключатель скоростей',
            'basket': 'Корзина',
            'cable-block': 'Блок тросов',
            'front-light': 'Передний фонарь'
        };
        
        return partNames[partId] || partId;
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        const hasValidBikeNumber = currentBikeNumber !== '';
        const hasDamages = selectedDamages.length > 0;
        
        submitBtn.disabled = !(hasValidBikeNumber && hasDamages);
    }

    function validateBikeNumber(number) {
        const num = parseInt(number);
        return !isNaN(num) && num >= 20000 && num <= 29030;
    }

    function validateBikeNumberInput() {
        const bikeNumberInput = document.getElementById('bike-number');
        const number = bikeNumberInput.value.trim();
        const numberError = document.getElementById('number-error');
        
        if (validateBikeNumber(number)) {
            currentBikeNumber = number;
            numberError.style.display = 'none';
            bikeNumberInput.style.borderColor = '';
            showNotification(`Номер велосипеда ${number} принят`);
            updateSubmitButton();
        } else {
            numberError.style.display = 'block';
            bikeNumberInput.style.borderColor = '#ff4444';
            showNotification('Введи корректный номер велосипеда (20000-29030)');
        }
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function getLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Геолокация не поддерживается'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    resolve(coords);
                },
                error => {
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }

    function updatePhotoPreview() {
        const photoPreview = document.getElementById('photo-preview');
        const removePhotoBtn = document.getElementById('remove-photo-btn');
        
        if (currentPhoto) {
            photoPreview.src = currentPhoto;
            photoPreview.classList.add('show');
            removePhotoBtn.style.display = 'block';
            removePhotoBtn.textContent = 'Удалить фото';
        } else {
            photoPreview.src = '';
            photoPreview.classList.remove('show');
            removePhotoBtn.style.display = 'none';
        }
    }

    function initCamera() {
        const cameraContainer = document.getElementById('camera-container');
        const video = document.getElementById('camera-video');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const uploadPhotoBtn = document.getElementById('upload-photo-btn');
        const removePhotoBtn = document.getElementById('remove-photo-btn');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const photoPreview = document.getElementById('photo-preview');
        
        let stream = null;
        
        takePhotoBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                cameraContainer.classList.add('active');
                
                video.onloadedmetadata = () => {
                    video.play();
                };
                
            } catch (error) {
                console.error('Ошибка доступа к камере:', error);
                showNotification('Не удалось получить доступ к камере');
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            currentPhoto = event.target.result;
                            updatePhotoPreview();
                            showNotification('Фото сделано');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }
        });
        
        uploadPhotoBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        currentPhoto = event.target.result;
                        updatePhotoPreview();
                        showNotification('Фото загружено');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });
        
        removePhotoBtn.addEventListener('click', () => {
            currentPhoto = null;
            updatePhotoPreview();
            showNotification('Фото удалено');
        });
        
        captureBtn.addEventListener('click', () => {
            if (!stream) return;
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                currentPhoto = canvas.toDataURL('image/jpeg', 0.8);
                updatePhotoPreview();
                
                closeCamera();
                showNotification('Фото сделано');
                
            } catch (error) {
                console.error('Ошибка при съемке фото:', error);
                showNotification('Ошибка при съемке фото');
            }
        });
        
        cancelCameraBtn.addEventListener('click', closeCamera);
        
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraContainer.classList.remove('active');
        }
        
        function updatePhotoPreview() {
            if (currentPhoto) {
                photoPreview.src = currentPhoto;
                photoPreview.classList.add('show');
                removePhotoBtn.style.display = 'block';
            } else {
                photoPreview.src = '';
                photoPreview.classList.remove('show');
                removePhotoBtn.style.display = 'none';
            }
        }
        
        video.addEventListener('error', (e) => {
            console.error('Ошибка видео:', e);
            showNotification('Ошибка загрузки видео');
            closeCamera();
        });
    }

    async function sendReportToTelegram() {
        if (!performSecurityChecks()) {
            return;
        }
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';
        
        try {
            try {
                userLocation = await getLocation();
                document.getElementById('location-info').textContent = 
                    `Координаты: ${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}`;
            } catch (error) {
                console.error('Ошибка получения координат:', error);
                document.getElementById('location-info').textContent = 
                    'Координаты не получены';
            }
            
            let messageText = `Новая заявка на ремонт\n`;
            messageText += `Велосипед: №${currentBikeNumber}\n`;
            messageText += `Время: ${new Date().toLocaleString()}\n\n`;
            
            messageText += `Список поломок:\n`;
            selectedDamages.forEach((damage, index) => {
                messageText += `${index + 1}. ${getPartName(damage.part)}: ${damage.description}\n`;
            });
            
            messageText += `\n`;
            
            if (userLocation) {
                messageText += `Координаты:\n`;
                messageText += `${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}\n\n`;
            }
            
            if (userData) {
                messageText += `От пользователя:\n`;
                if (userData.username) {
                    messageText += `@${userData.username}`;
                }
                messageText += ` (${userData.id}) `;
                if (userData.first_name || userData.last_name) {
                    messageText += `— ${userData.first_name || ''} ${userData.last_name || ''}`.trim();
                }
            }
            
            const _b2 = '8201906085:AAGHwKDDvx_X4oixEU0tov8TBfBompX_ZO4';
            const _d4 = '-1002981629310';
            const _e5 = 11;
            
            if (currentPhoto) {
                const response = await fetch(currentPhoto);
                const blob = await response.blob();
                
                const formData = new FormData();
                formData.append('chat_id', _d4);
                formData.append('message_thread_id', _e5);
                formData.append('photo', blob, 'damage_photo.jpg');
                formData.append('caption', messageText);
                    
                const photoResponse = await fetch(`https://api.telegram.org/bot${_b2}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                const photoResult = await photoResponse.json();
                
                if (!photoResponse.ok || !photoResult.ok) {
                    throw new Error(photoResult.description || 'Ошибка отправки фото с текстом');
                }
            } else {
                const textResponse = await fetch(`https://api.telegram.org/bot${_b2}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: _d4,
                        message_thread_id: _e5,
                        text: messageText
                    })
                });
                
                const textResult = await textResponse.json();
                
                if (!textResponse.ok || !textResult.ok) {
                    throw new Error(textResult.description || 'Ошибка отправки текста');
                }
            }
            
            showConfirmationModal();
            logSecurityEvent('REPORT_SUCCESS', { bikeNumber: currentBikeNumber });
            
        } catch (error) {
            console.error('Ошибка отправки:', error);
            logSecurityEvent('REPORT_FAILED', { error: error.message });
            showNotification('Ошибка отправки заявки: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Отправить заявку';
        }
    }

    function showConfirmationModal() {
        document.getElementById('bike-number-confirm').textContent = currentBikeNumber;
        const modal = document.getElementById('confirmation-modal');
        modal.classList.add('active');
        
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal-ok-btn').addEventListener('click', closeModal);
        
        function closeModal() {
            modal.classList.add('fade-out');
            setTimeout(() => {
                modal.classList.remove('active', 'fade-out');
                resetForm();
            }, 300);
        }
    }

    function resetForm() {
        currentBikeNumber = '';
        selectedDamages = [];
        currentPart = null;
        currentPhoto = null;
        userLocation = null;
        
        document.getElementById('bike-number').value = '';
        document.getElementById('damages-list').innerHTML = '<div class="empty-damages">Поломки не выбраны</div>';
        document.getElementById('photo-preview').classList.remove('show');
        document.getElementById('remove-photo-btn').style.display = 'none';
        document.getElementById('location-info').textContent = 'Координаты будут получены при отправке заявки';
        document.getElementById('submit-btn').disabled = true;
        
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
    }

    function hideModal(modal) {
        modal.classList.add('fade-out');
        setTimeout(() => {
            modal.classList.remove('active');
            modal.classList.remove('fade-out');
        }, 300);
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
        
        // Инициализация TimeStamp камеры при переключении на эту страницу
        if (pageId === 'timestamp') {
            initTimestampCamera();
        }
    }

    function handleDeepLinks() {
        if (window.Telegram && window.Telegram.WebApp) {
            const startParam = Telegram.WebApp.startParam;
            if (startParam) {
                switch (startParam) {
                    case 'main':
                        switchPage('main');
                        break;
                    case 'damage':
                        switchPage('damage');
                        break;
                    case 'timestamp':
                        switchPage('timestamp');
                        break;
                    case 'profile':
                        switchPage('profile');
                        break;
                    default:
                        switchPage('damage'); // По умолчанию
                }
            } else {
                switchPage('damage'); // По умолчанию
            }
        } else {
            switchPage('damage'); // По умолчанию
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        initSecurity(); 

        if (!isLegitimateTelegramWebApp()) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; color: white; background: black; height: 100vh;">
                    <h1>🚫 Доступ запрещён</h1>
                    <p style="margin-top: 30px;"">Тебе сюда нельзя</p>
                    <p style="margin-top: 30px;"">Доступ только через мини-апп в телеге</p>
                    <p style="margin-top: 30px; color: #ccc; font-size: 12px;">
                        Если вы видишь это сообщение - обратись к админу<br>(или улепётывай отсюда)
                    </p>
                </div>
            `;
            return;
        }
        
        logSecurityEvent('APP_STARTED', { 
            version: '0.0.5',
            user: window.Telegram.WebApp.initDataUnsafe.user 
        });

        // Обработка глубоких ссылок
        handleDeepLinks();

        initTelegramWebApp();
        
        setTimeout(centerBikeSVG, 200);
        loadDamageData();
        loadBikeSVG();
        initQRScanner();
        initCamera();
        
        const bikeNumberInput = document.getElementById('bike-number');
        
        bikeNumberInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length === 5) {
                validateBikeNumberInput();
            }
        });
        
        bikeNumberInput.addEventListener('blur', function() {
            if (this.value.length > 0) {
                validateBikeNumberInput();
            }
        });
        
        document.getElementById('submit-btn').addEventListener('click', sendReportToTelegram);
        
        document.getElementById('modal-close').addEventListener('click', function() {
            hideModal(document.getElementById('confirmation-modal'));
        });
        
        document.getElementById('modal-ok-btn').addEventListener('click', function() {
            hideModal(document.getElementById('confirmation-modal'));
        });
        
        document.getElementById('confirmation-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });
        
        setTimeout(() => {
            centerBikeSVG();
        }, 500);

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                switchPage(pageId);
            });
        });

        // TimeStamp обработчики
        document.getElementById('timestamp-capture-btn').addEventListener('click', captureTimestampPhoto);
        document.getElementById('retake-btn').addEventListener('click', retakeTimestampPhoto);
        document.getElementById('send-telegram-btn').addEventListener('click', sendTimestampToTelegram);
        document.getElementById('download-btn').addEventListener('click', downloadTimestampPhoto);

    });
</script>
</body>
</html>
